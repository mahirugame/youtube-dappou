<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>脱法YouTube — 完全版</title>
<style>
/* === 元の見た目そのまま === */
:root{--bg:#fff;--text:#111;--sidebar:#f8f9fb;--border:#e6e9ee;--card:#fff;--hover:#f2f5fa;--accent:#ff3b30;--muted:#6b6b6b}
body.dark{--bg:#0b0c0d;--text:#e6e6e6;--sidebar:#0f1113;--border:#222426;--card:#121214;--hover:#1a1c1e;--accent:#ff5b5b;--muted:#9a9a9a}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.app{display:flex;height:100vh;transition:all .18s ease}
.sidebar{width:360px;min-width:260px;max-width:460px;background:var(--sidebar);border-right:1px solid var(--border);padding:14px;display:flex;flex-direction:column;gap:10px;overflow:auto}
.main{flex:1;display:flex;flex-direction:column;gap:12px;padding:16px;overflow:auto;background:var(--bg)}
.header-row{display:flex;gap:8px;align-items:center}
.toggle-theme{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--border);cursor:pointer}
#searchInput{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
#searchBtn{padding:10px 12px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:700;cursor:pointer}
.results-list{flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto;padding-bottom:40px}
.result-item{display:flex;gap:12px;padding:12px;border-radius:12px;background:var(--card);border:1px solid var(--border);cursor:pointer;align-items:flex-start;position:relative;transition:transform .12s,box-shadow .12s}
.result-item:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.08)}
.result-thumb{position:relative;width:168px;flex:0 0 168px}
.result-thumb img{width:168px;height:94px;object-fit:cover;border-radius:8px;display:block;background:linear-gradient(90deg,#eee,#ddd)}
.add-queue-btn{position:absolute;right:6px;bottom:6px;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:6px 8px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.15);transition:transform .15s}
.add-queue-btn:hover{transform:scale(1.3)}
.video-container{position:relative;padding-top:56.25%;background:#000;border-radius:12px;overflow:hidden}
#ytplayer{position:absolute;top:0;left:0;width:100%;height:100%;border:0;z-index:5}
.queue-popup{position:fixed;right:20px;bottom:20px;width:340px;max-height:46vh;z-index:1500;border-radius:14px;overflow:hidden;box-shadow:0 18px 40px rgba(0,0,0,0.24);background:var(--card);border:1px solid var(--border);display:flex;flex-direction:column;transition:transform .28s,opacity .2s}
.queue-popup.collapsed{transform:translateY(calc(100% - 56px));opacity:.96}
.queue-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--sidebar);border-bottom:1px solid var(--border);cursor:pointer}
.queue-list{overflow:auto;display:flex;flex-direction:column;max-height:340px}
.queue-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);cursor:default}
.queue-item.playing{background:var(--hover);font-weight:700;color:var(--accent)}
.queue-notice{position:fixed;right:20px;top:20px;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(-8px);transition:all .25s;z-index:9999}
.queue-notice.show{opacity:1;transform:translateY(0)}
.loading-overlay{position:fixed;right:20px;bottom:20px;background:rgba(0,0,0,0.6);color:white;padding:10px 12px;border-radius:10px;display:none;align-items:center;gap:8px;z-index:2000}
.spinner{width:16px;height:16px;border-radius:50%;border:3px solid rgba(255,255,255,0.2);border-top-color:white;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.queue-toggle-btn {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  z-index: 1600;
  border: none;
  transition: transform 0.2s ease, opacity 0.2s;
}
.queue-toggle-btn:hover {
  transform: scale(1.15);
}
.queue-toggle-btn.hidden {
  opacity: 0;
  pointer-events: none;
}
.queue-popup {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 340px;
  max-height: 46vh;
  z-index: 1500;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 18px 40px rgba(0,0,0,0.24);
  background: var(--card);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transition: transform .28s, opacity .2s;
  pointer-events: auto; /* 折りたたみ中の操作を許可/不可にする */
}

.queue-popup.collapsed {
  transform: translateY(calc(100% - 56px));
  opacity: 0;
  pointer-events: none; /* 折りたたみ中はクリック不可 */
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="header-row">
      <div class="toggle-theme" id="toggleTheme">🌙</div>
      <input id="searchInput" placeholder="動画を検索 (YouTube Data API)"/>
      <button id="searchBtn">検索</button>
    </div>
    <div class="results-list" id="results">検索結果がここに表示されます</div>
  </aside>
  <main class="main">
    <div class="video-container" id="player">
      <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;background:#000;">動画を選択してください</div>
    </div>
    <div class="video-info" id="videoInfo"></div>
  </main>
</div>

<div class="queue-popup collapsed" id="queuePopup">
  <div class="queue-header" id="queueHeader">
    <strong>▶ キュー</strong><small id="queueCount"></small>
    <div>
      <button id="clearQueueBtn">クリア</button>
      <button id="shuffleBtn">🔀</button>
      <button id="repeatBtn">🔁</button>
    </div>
  </div>
  <div class="queue-list" id="queueList"></div>
</div>

<div id="queueNotice" class="queue-notice">キューに追加しました</div>
<div id="loading" class="loading-overlay"><div class="spinner"></div><div id="loadingText">読み込み中…</div></div>
<script>
/* ==================== CONFIG ==================== */
const API_KEYS = [
  "AIzaSyAsNToibXb37DIGsW03M2wfCqliQ49Lhm0",
  "AIzaSyAsfvwnZ50xEQ8VvvcG59BR5EIfpFjC4bs",
  "AIzaSyDrZwGkrVtsp61zDUKj6WS-UWh3shUvRNg",
  "AIzaSyAe0JSOE67-VLVzg-7BCMgJUM8SA1rmcSc",
  "AIzaSyDUOAn-nKORPpnKXt4Q12tMCMPbGGP7q48",
  "AIzaSyBJYGuChAwPaPTbfryHJ7F2p1eTVTXsREA",
  "AIzaSyCiOUkDyYmeRGJm5ZY2HSz9z2svN4j0gHg",
  "AIzaSyD1Qw8NPVWgE2RK9XKkGxXGneP12plw1Tk"
];
let apiIndex = 0;
function getApiKey() {
  const key = API_KEYS[apiIndex];
  apiIndex = (apiIndex + 1) % API_KEYS.length;
  return key;
}

/* ==================== ELEMENTS ==================== */
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const resultsDiv = document.getElementById("results");
const playerDiv = document.getElementById("player");
const queuePopup = document.getElementById("queuePopup");
const queueList = document.getElementById("queueList");
const queueCount = document.getElementById("queueCount");
const queueHeader = document.getElementById("queueHeader");
const clearQueueBtn = document.getElementById("clearQueueBtn");
const shuffleBtn = document.getElementById("shuffleBtn");
const repeatBtn = document.getElementById("repeatBtn");
const queueNotice = document.getElementById("queueNotice");
const videoInfoDiv = document.getElementById("videoInfo");

/* ==================== QUEUE TOGGLE BUTTON ==================== */
const queueToggleBtn = document.createElement("button");
queueToggleBtn.className = "queue-toggle-btn";
queueToggleBtn.innerHTML = "☰";
document.body.appendChild(queueToggleBtn);
queueToggleBtn.onclick = () => expandQueue();

function expandQueue() {
  queuePopup.classList.remove("collapsed");
  queueToggleBtn.classList.add("hidden");
}
function collapseQueue() {
  queuePopup.classList.add("collapsed");
  queueToggleBtn.classList.remove("hidden");
}

/* ==================== VARIABLES ==================== */
let ytPlayer, ytApiReady = false;
let queue = JSON.parse(localStorage.getItem("yt_queue") || "[]");
let currentPlayingId = null;
let shuffleMode = false, repeatMode = false;
let currentQuery = "", nextPageToken = null;
let currentChannelId = null;

/* ==================== SEARCH ==================== */
searchBtn.onclick = startSearch;
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") startSearch();
});

async function startSearch() {
  currentQuery = searchInput.value.trim();
  currentChannelId = null;
  if (!currentQuery) return;
  nextPageToken = null;
  resultsDiv.innerHTML = "読み込み中…";
  await fetchResults(false);
}

async function fetchResults(append = false) {
  try {
    const key = getApiKey();
    let url = new URL("https://www.googleapis.com/youtube/v3/search");
    const params = {
      part: "snippet",
      type: "video",
      maxResults: 15,
      key,
      pageToken: nextPageToken || ""
    };
    if (currentChannelId) params.channelId = currentChannelId;
    else params.q = currentQuery;
    url.search = new URLSearchParams(params);
    const res = await fetch(url);
    const data = await res.json();
    nextPageToken = data.nextPageToken || null;
    if (!append) resultsDiv.innerHTML = "";
    data.items.forEach(renderResult);
  } catch (err) {
    console.error("Fetch Error:", err);
  }
}

/* 無限スクロール */
resultsDiv.addEventListener("scroll", async () => {
  if (resultsDiv.scrollTop + resultsDiv.clientHeight >= resultsDiv.scrollHeight - 40) {
    await fetchResults(true);
  }
});

/* ==================== RENDER RESULT ==================== */
function renderResult(item) {
  const vid = item.id.videoId;
  const el = document.createElement("div");
  el.className = "result-item";

  const thumbDiv = document.createElement("div");
  thumbDiv.className = "result-thumb";
  const img = document.createElement("img");
  img.src = item.snippet.thumbnails.medium.url;
  thumbDiv.appendChild(img);

  const addBtn = document.createElement("button");
  addBtn.className = "add-queue-btn";
  addBtn.textContent = "＋";
  addBtn.onclick = e => {
    e.stopPropagation();
    addToQueue(vid, item.snippet.title);
  };
  thumbDiv.appendChild(addBtn);
  el.appendChild(thumbDiv);

  const infoDiv = document.createElement("div");
  infoDiv.className = "result-info";
  const title = document.createElement("div");
  title.className = "result-title";
  title.textContent = item.snippet.title;
  infoDiv.appendChild(title);

  const channel = document.createElement("div");
  channel.className = "result-channel";
  channel.textContent = item.snippet.channelTitle;
  channel.onclick = e => {
    e.stopPropagation();
    loadChannelVideos(item.snippet.channelId);
  };
  infoDiv.appendChild(channel);

  // ✅ 検索結果クリックで動画再生できるよう修正
  el.onclick = e => {
    e.stopPropagation();
    loadVideoAndPlay(vid, item.snippet.title);
    // クリックした動画をキューに自動追加
    if (!queue.some(v => v.id === vid)) {
      queue.push({ id: vid, title: item.snippet.title });
      saveQueue();
    }
  };

  el.appendChild(infoDiv);
  resultsDiv.appendChild(el);
}

/* ==================== CHANNEL MODE ==================== */
async function loadChannelVideos(channelId) {
  currentChannelId = channelId;
  currentQuery = "";
  nextPageToken = null;
  resultsDiv.innerHTML = "チャンネルの動画を読み込み中…";
  await fetchResults(false);
}

/* ==================== QUEUE ==================== */
function addToQueue(id, title) {
  queue.push({ id, title });
  saveQueue();
  showNotice("キューに追加しました");
}

function saveQueue() {
  localStorage.setItem("yt_queue", JSON.stringify(queue));
  renderQueue();
}

function renderQueue() {
  queueList.innerHTML = "";
  queue.forEach((v, i) => {
    const item = document.createElement("div");
    item.className = "queue-item";
    item.textContent = v.title;
    item.onclick = () => loadVideoAndPlay(v.id, v.title);
    const del = document.createElement("button");
    del.textContent = "×";
    del.onclick = e => {
      e.stopPropagation();
      queue.splice(i, 1);
      saveQueue();
    };
    item.appendChild(del);
    queueList.appendChild(item);
  });
  queueCount.textContent = `${queue.length} 件`;

  if (queue.length === 0) {
    queuePopup.style.display = "none";
    queueToggleBtn.classList.add("hidden");
  } else {
    queuePopup.style.display = "flex";
    queueToggleBtn.classList.remove("hidden");
  }
}
clearQueueBtn.onclick = () => { queue = []; saveQueue(); };
queueHeader.onclick = () => collapseQueue();
renderQueue();

/* ==================== NOTICE ==================== */
function showNotice(msg) {
  queueNotice.textContent = msg;
  queueNotice.classList.add("show");
  setTimeout(() => queueNotice.classList.remove("show"), 1200);
}

/* ==================== IFRAME API ==================== */
const tag = document.createElement("script");
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

window.onYouTubeIframeAPIReady = () => { ytApiReady = true; };

/* ==================== PLAYER ==================== */
function createPlayer(id) {
  playerDiv.innerHTML = '<div id="ytplayer"></div>';
  ytPlayer = new YT.Player("ytplayer", {
    videoId: id,
    playerVars: { rel: 0, controls: 1, enablejsapi: 1, origin: window.location.origin },
    events: {
      onReady: e => e.target.playVideo(),
      onStateChange: onPlayerStateChange
    }
  });
}

function loadVideoAndPlay(id, title) {
  currentPlayingId = id;
  if (!ytApiReady) return showNotice("プレイヤー準備中…");
  if (ytPlayer && ytPlayer.loadVideoById) ytPlayer.loadVideoById(id);
  else createPlayer(id);
  updateVideoInfo(title);
}

function onPlayerStateChange(e) {
  if (e.data === YT.PlayerState.ENDED) {
    playNext();
  }
}

function playNext() {
  if (queue.length === 0) return;
  let idx = queue.findIndex(v => v.id === currentPlayingId);
  if (shuffleMode) idx = Math.floor(Math.random() * queue.length);
  else if (repeatMode) idx = idx;
  else idx++;
  if (idx >= queue.length) return;
  const next = queue[idx];
  loadVideoAndPlay(next.id, next.title);
}

/* ==================== INFO ==================== */
function updateVideoInfo(title) {
  videoInfoDiv.innerHTML = `<div class="video-title">${title}</div>`;
}

/* ==================== MODES ==================== */
shuffleBtn.onclick = () => {
  shuffleMode = !shuffleMode;
  shuffleBtn.style.color = shuffleMode ? "#2b6db3" : "inherit";
};
repeatBtn.onclick = () => {
  repeatMode = !repeatMode;
  repeatBtn.style.color = repeatMode ? "#2b6db3" : "inherit";
};
function expandQueue() {
  queuePopup.classList.remove("collapsed");
  queueToggleBtn.classList.add("hidden");
}

function collapseQueue() {
  queuePopup.classList.add("collapsed");
  queueToggleBtn.classList.remove("hidden");
}
function onPlayerStateChange(e) {
  if (e.data === YT.PlayerState.ENDED) {
    // 次の動画があれば再生
    playNext();
  }

  // ここで現在再生中のキューアイテムを強調表示
  renderQueue();
}

function playNext() {
  if (queue.length === 0) return;

  // 現在再生中の動画のインデックスを取得
  let idx = queue.findIndex(v => v.id === currentPlayingId);

  if (shuffleMode) {
    // シャッフル
    idx = Math.floor(Math.random() * queue.length);
  } else if (!repeatMode) {
    // 通常モード
    idx++;
  } // repeatMode の場合は idx を変えない（同じ動画を繰り返す）

  if (idx >= queue.length) return; // キュー末尾なら終了

  const next = queue[idx];
  currentPlayingId = next.id; // 現在再生中IDを更新
  loadVideoAndPlay(next.id, next.title);
}
</script>

</body>
</html>
